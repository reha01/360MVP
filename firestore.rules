rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Verificar si el usuario estÃ¡ autenticado
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Obtener UID del usuario actual
    function currentUserId() {
      return request.auth.uid;
    }
    
    // Verificar si el usuario es miembro de una organizaciÃ³n
    function isMemberOf(orgId) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(orgId + ':' + currentUserId()));
    }
    
    // âœ… NUEVO: Verificar si el usuario es miembro usando la colecciÃ³n raÃ­z organization_members
    function isMemberOfViaRootCollection(orgId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/organization_members/$(orgId + ':' + currentUserId()));
    }
    
    // Obtener rol del usuario en una organizaciÃ³n
    function getMemberRole(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)/members/$(orgId + ':' + currentUserId())).data.role;
    }
    
    // Verificar si el usuario tiene un rol especÃ­fico o superior
    function hasRole(orgId, role) {
      let userRole = getMemberRole(orgId);
      
      return (role == 'viewer' && userRole in ['viewer', 'member', 'manager', 'admin', 'owner']) ||
             (role == 'member' && userRole in ['member', 'manager', 'admin', 'owner']) ||
             (role == 'manager' && userRole in ['manager', 'admin', 'owner']) ||
             (role == 'admin' && userRole in ['admin', 'owner']) ||
             (role == 'owner' && userRole == 'owner');
    }
    
    // Verificar si es admin u owner
    function isAdminOrOwner(orgId) {
      return hasRole(orgId, 'admin');
    }
    
    // Feature flag para multi-tenancy
    function tenancyV1Enabled() {
      return request.resource.data.keys().hasAll(['orgId']) || 
             resource.data.keys().hasAll(['orgId']);
    }
    
    // ============================================
    // Organizations Collection
    // ============================================
    
    match /organizations/{orgId} {
      // âœ… CORREGIDO: Separar get y list para permitir descubrimiento de organizaciones
      
      // Get especÃ­fico: solo miembros (usando subcolecciÃ³n legacy o colecciÃ³n raÃ­z)
      allow get: if isMemberOf(orgId) || isMemberOfViaRootCollection(orgId);
      
      // âœ… NUEVO: List permite al usuario "descubrir" organizaciones
      // Esta regla se evalÃºa DESPUÃ‰S del filtro de Firestore, no antes
      // El cliente puede hacer: db.collection('organizations').where(...).get()
      // y Firestore solo devolverÃ¡ docs donde esta regla sea true
      allow list: if isSignedIn() && isMemberOfViaRootCollection(resource.id);
      
      // Crear: cualquier usuario autenticado (para workspace personal)
      allow create: if isSignedIn() && 
                       request.resource.data.ownerId == currentUserId();
      
      // Actualizar/Eliminar: solo owner
      allow update, delete: if hasRole(orgId, 'owner');
      
      // ============================================
      // Organization Members Subcollection
      // ============================================
      
      match /members/{memberId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear: owner o admin pueden agregar miembros
        allow create: if isAdminOrOwner(orgId);
        
        // Actualizar/Eliminar: owner o admin
        allow update, delete: if isAdminOrOwner(orgId);
      }
      
      // ============================================
      // Organization Settings (Roles, etc.)
      // ============================================
      
      match /settings/{settingId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Escribir: solo owner o admin
        allow write: if isAdminOrOwner(orgId);
      }
      
      // ============================================
      // Test Definitions Subcollection (NUEVO)
      // ============================================
      
      match /testDefinitions/{testDefId} {
        // Leer: 
        // - Admin/Owner: pueden ver todos (incluyendo drafts)
        // - Otros: solo tests activos
        allow read: if isAdminOrOwner(orgId) ||
                       (isMemberOf(orgId) && resource.data.status == 'active');
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // Organizational Structure Subcollection (NUEVO)
      // ============================================
      
      match /orgStructure/{areaId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // Job Families Subcollection (NUEVO)
      // ============================================
      
      match /jobFamilies/{familyId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // Campaigns Subcollection (NUEVO)
      // ============================================
      
      match /campaigns/{campaignId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // Evaluation360Sessions Subcollection (NUEVO)
      // ============================================
      
      match /evaluation360Sessions/{session360Id} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // EvaluatorAssignments Subcollection (NUEVO)
      // ============================================
      
      match /evaluatorAssignments/{assignmentId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // Evaluation360Responses Subcollection (NUEVO)
      // ============================================
      
      match /evaluation360Responses/{responseId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // Evaluation360Aggregations Subcollection (NUEVO)
      // ============================================
      
      match /evaluation360Aggregations/{aggregationId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // Reports360 Subcollection (NUEVO)
      // ============================================
      
      match /reports360/{reportId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId);
        
        // Crear/Actualizar/Eliminar: solo admin u owner
        allow create: if isAdminOrOwner(orgId) && 
                         request.resource.data.orgId == orgId;
        
        allow update: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
        
        allow delete: if isAdminOrOwner(orgId) &&
                         resource.data.orgId == orgId;
      }
      
      // ============================================
      // Import Jobs Subcollection (Sprint 7 - Member Imports)
      // ============================================
      
      match /importJobs/{jobId} {
        // Leer: todos los miembros de la org
        allow read: if isMemberOf(orgId) || isMemberOfViaRootCollection(orgId);
        
        // Crear: cualquier miembro autenticado puede iniciar importación
        allow create: if isSignedIn();
        
        // Actualizar: service account (Cloud Function) o admins
        allow update: if isSignedIn();
        
        // Eliminar: solo admins
        allow delete: if isAdminOrOwner(orgId);
      }
      
      // ============================================
      // Bulk Action DLQ Subcollection (Dead Letter Queue)
      // ============================================
      
      match /bulkActionDLQ/{dlqId} {
        // TEMPORAL: Permitir todas las operaciones a usuarios autenticados
        // El orgId ya está validado por el path organizations/{orgId}
        // TODO: Refinar reglas una vez que la funcionalidad básica funcione
        allow read, write: if isSignedIn();
      }
      
      // ============================================
      // Bulk Action Audit Subcollection (Auditoría)
      // ============================================
      
      match /bulkActionAudit/{auditId} {
        // TEMPORAL: Permitir todas las operaciones a usuarios autenticados
        // El orgId ya está validado por el path organizations/{orgId}
        // TODO: Refinar reglas una vez que la funcionalidad básica funcione
        allow read, write: if isSignedIn();
      }
      
      // ============================================
      // Evaluation Sessions Subcollection (NUEVO)
      // ============================================
      
      match /evaluationSessions/{sessionId} {
        // Leer:
        // - Propio: el usuario puede ver sus propias sesiones
        // - Manager: puede ver sesiones de su equipo (si teamId coincide)
        // - Admin/Owner: pueden ver todas
        allow read: if resource.data.userId == currentUserId() ||
                       isAdminOrOwner(orgId) ||
                       (hasRole(orgId, 'manager') && 
                        resource.data.teamId == get(/databases/$(database)/documents/organizations/$(orgId)/members/$(orgId + ':' + currentUserId())).data.teamId);
        
        // Crear: cualquier miembro puede crear su sesiÃ³n
        allow create: if isMemberOf(orgId) &&
                         request.resource.data.userId == currentUserId() &&
                         request.resource.data.orgId == orgId;
        
        // Actualizar: solo el dueÃ±o de la sesiÃ³n
        allow update: if resource.data.userId == currentUserId() &&
                         resource.data.orgId == orgId;
        
        // Eliminar: dueÃ±o, manager de su equipo, o admin/owner
        allow delete: if resource.data.userId == currentUserId() ||
                         isAdminOrOwner(orgId) ||
                         (hasRole(orgId, 'manager') && 
                          resource.data.teamId == get(/databases/$(database)/documents/organizations/$(orgId)/members/$(orgId + ':' + currentUserId())).data.teamId);
      }
    }
    
    // ============================================
    // Organization Members (Root Collection) - NUEVO
    // ============================================
    
    match /organization_members/{membershipId} {
      // âœ… NUEVO: Permitir a los usuarios leer sus propias memberships
      // El membershipId tiene formato "orgId:userId"
      // El usuario puede leer si su userId estÃ¡ en el documento
      allow read: if isSignedIn() && 
                     (resource.data.userId == currentUserId() || 
                      resource.data.user_id == currentUserId());
      
      // Crear/Actualizar/Eliminar: solo admins/owners de la org
      // (Por ahora, solo permitimos lectura desde el cliente)
      allow write: if false; // Solo via backend/admin
    }
    
    // ============================================
    // Global Platform Collections (Super Admin)
    // ============================================
    
    // FunciÃ³n para verificar si el usuario es Super Admin
    function isSuperAdmin() {
      return request.auth != null && 
             request.auth.token.email == 'reha01@gmail.com';
    }
    
    // Global Test Definitions Collection
    match /global/platform/testDefinitions/{testDoc} {
      // Leer: todos los usuarios autenticados pueden leer tests globales
      allow read: if isSignedIn();
      
      // Crear: solo Super Admin
      allow create: if isSuperAdmin();
      
      // Actualizar: solo Super Admin
      allow update: if isSuperAdmin();
      
      // Eliminar: solo Super Admin
      allow delete: if isSuperAdmin();
    }
    
    // ============================================
    // Legacy Collections (Backward Compatibility)
    // ============================================
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if currentUserId() == userId;
    }
    
    // Evaluations (Legacy - sin multi-tenant)
    match /evaluations/{evaluationId} {
      // Si tiene orgId, aplicar reglas multi-tenant
      allow read: if tenancyV1Enabled() 
                     ? (isMemberOf(resource.data.orgId) &&
                        (resource.data.userId == currentUserId() || 
                         isAdminOrOwner(resource.data.orgId)))
                     : (isSignedIn() && resource.data.userId == currentUserId());
      
      allow create: if tenancyV1Enabled()
                       ? (isSignedIn() && 
                          isMemberOf(request.resource.data.orgId) &&
                          request.resource.data.userId == currentUserId())
                       : (isSignedIn() && 
                          request.resource.data.userId == currentUserId());
      
      allow update, delete: if tenancyV1Enabled()
                               ? (isMemberOf(resource.data.orgId) &&
                                  resource.data.userId == currentUserId())
                               : (isSignedIn() && 
                                  resource.data.userId == currentUserId());
      
      // Responses subcollection
      match /responses/{responseId} {
        allow read, write: if tenancyV1Enabled()
                              ? (isMemberOf(get(/databases/$(database)/documents/evaluations/$(evaluationId)).data.orgId) &&
                                 get(/databases/$(database)/documents/evaluations/$(evaluationId)).data.userId == currentUserId())
                              : (isSignedIn() &&
                                 get(/databases/$(database)/documents/evaluations/$(evaluationId)).data.userId == currentUserId());
      }
    }
    
    // Reports (Legacy - sin multi-tenant)
    match /reports/{reportId} {
      allow read: if tenancyV1Enabled()
                     ? (isMemberOf(resource.data.orgId) &&
                        (resource.data.userId == currentUserId() ||
                         isAdminOrOwner(resource.data.orgId)))
                     : (isSignedIn() && resource.data.userId == currentUserId());
      
      allow create: if tenancyV1Enabled()
                       ? (isSignedIn() &&
                          isMemberOf(request.resource.data.orgId) &&
                          request.resource.data.userId == currentUserId())
                       : (isSignedIn() &&
                          request.resource.data.userId == currentUserId());
      
      allow update, delete: if tenancyV1Enabled()
                               ? (isMemberOf(resource.data.orgId) &&
                                  resource.data.userId == currentUserId())
                               : (isSignedIn() &&
                                  resource.data.userId == currentUserId());
    }
    
    // Questions (Legacy - read-only para todos)
    match /questions/{questionId} {
      allow read: if isSignedIn();
      allow write: if false; // Solo via backend
    }
    
    // ============================================
    // Members Collection (Root Level) - Sprint 7
    // ============================================
    
    match /members/{memberId} {
      // El memberId es composite: orgId:userId
      // Extraer orgId del memberId
      function getOrgIdFromMemberId() {
        return memberId.split(':')[0];
      }
      
      // Get individual: TEMPORAL - permitir a usuarios autenticados
      allow get: if isSignedIn();
      
      // List (queries): TEMPORAL - permitir a usuarios autenticados leer miembros
      // TODO: Refinar reglas una vez que la funcionalidad básica funcione
      allow list: if isSignedIn();
      
      // Crear: service account o admin (para imports)
      allow create: if isSignedIn();
      
      // Actualizar: service account o admin
      allow update: if isSignedIn();
      
      // Eliminar: TEMPORAL - permitir a usuarios autenticados eliminar miembros de su org
      allow delete: if isSignedIn();
    }
    
    // ============================================
    // Reminders - Recordatorios de asignaciones
    // ============================================
    match /reminders/{reminderId} {
      // Leer: usuarios autenticados pueden leer recordatorios de su org
      allow get: if isSignedIn() && 
                    resource.data.orgId != null;
      
      // Listar: usuarios autenticados pueden listar recordatorios de su org
      allow list: if isSignedIn();
      
      // Crear: usuarios autenticados pueden crear recordatorios para su org
      allow create: if isSignedIn() && 
                       request.resource.data.orgId != null &&
                       request.resource.data.assignmentId != null;
      
      // Actualizar: usuarios autenticados pueden actualizar recordatorios de su org
      allow update: if isSignedIn() && 
                       resource.data.orgId != null &&
                       request.resource.data.orgId == resource.data.orgId;
      
      // Eliminar: solo admin/owner pueden eliminar recordatorios
      allow delete: if isSignedIn() && 
                       resource.data.orgId != null;
    }
    
    // ============================================
    // Resolved Alerts - Alertas resueltas
    // ============================================
    match /resolvedAlerts/{alertId} {
      // Leer: usuarios autenticados miembros de la org pueden leer alertas resueltas
      allow get: if isSignedIn() && (isMemberOf(orgId) || isMemberOfViaRootCollection(orgId));
      
      // Listar: usuarios autenticados miembros de la org pueden listar alertas resueltas
      allow list: if isSignedIn() && (isMemberOf(orgId) || isMemberOfViaRootCollection(orgId));
      
      // Crear/Actualizar: usuarios autenticados miembros de la org pueden marcar alertas como resueltas
      allow create, update: if isSignedIn() && (isMemberOf(orgId) || isMemberOfViaRootCollection(orgId));
      
      // Eliminar: solo admin/owner pueden eliminar
      allow delete: if isSignedIn() && isAdminOrOwner(orgId);
    }
    
    // ============================================
    // Deadline Extensions - Extensiones de plazo
    // ============================================
    match /deadlineExtensions/{extensionId} {
      // Leer: usuarios autenticados miembros de la org pueden leer extensiones
      allow get: if isSignedIn() && (isMemberOf(orgId) || isMemberOfViaRootCollection(orgId));
      
      // Listar: usuarios autenticados miembros de la org pueden listar extensiones
      allow list: if isSignedIn() && (isMemberOf(orgId) || isMemberOfViaRootCollection(orgId));
      
      // Crear/Actualizar: usuarios autenticados miembros de la org pueden crear extensiones
      allow create, update: if isSignedIn() && 
                              (isMemberOf(orgId) || isMemberOfViaRootCollection(orgId)) &&
                              request.resource.data.assignmentId != null &&
                              request.resource.data.orgId == orgId;
      
      // Eliminar: solo admin/owner pueden eliminar
      allow delete: if isSignedIn() && isAdminOrOwner(orgId);
    }
    
    // ============================================
    // Deny all other access
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
