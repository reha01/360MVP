<!DOCTYPE html>
<html>
<head>
    <title>Test Loop Fix - 360MVP</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #0f0; }
        .cmd { background: #000; padding: 10px; margin: 10px 0; cursor: pointer; }
        .cmd:hover { background: #111; }
        .result { background: #222; padding: 10px; margin: 10px 0; color: #fff; }
        h2 { color: #0ff; }
        .warning { color: #ff0; }
        .error { color: #f00; }
        .success { color: #0f0; }
    </style>
</head>
<body>
    <h1>üîß 360MVP - Loop Fix Test</h1>
    
    <div class="section">
        <h2>üìã Causa Ra√≠z Encontrada</h2>
        <div class="result">
            <p><strong class="error">PROBLEMA #1:</strong> OrgProvider estaba FUERA del Router</p>
            <pre>
&lt;AuthProvider&gt;
  &lt;OrgProvider&gt;  ‚ùå FUERA del Router
    &lt;Router&gt;    ‚ùå Router DENTRO
            </pre>
            <p>‚û°Ô∏è <strong class="success">SOLUCIONADO:</strong> Movido OrgProvider DENTRO del Router</p>
        </div>
        
        <div class="result">
            <p><strong class="error">PROBLEMA #2:</strong> loadOnceRef era local al componente</p>
            <p>‚û°Ô∏è <strong class="success">SOLUCIONADO:</strong> Module-scope loaders Map por uid</p>
        </div>
        
        <div class="result">
            <p><strong class="error">PROBLEMA #3:</strong> setStatus('idle') en user change re-disparaba el loader</p>
            <p>‚û°Ô∏è <strong class="success">SOLUCIONADO:</strong> Solo resetear cuando no hay user</p>
        </div>
    </div>
    
    <div class="section">
        <h2>üöÄ Comandos de Prueba en Staging</h2>
        
        <div class="cmd" onclick="copyCmd(this, 'localStorage.setItem(\'DEBUG_ORGCTX\', \'1\'); location.reload();')">
            <strong>1. Activar Debug Mode:</strong><br>
            localStorage.setItem('DEBUG_ORGCTX', '1'); location.reload();
        </div>
        
        <div class="cmd" onclick="copyCmd(this, 'localStorage.removeItem(\'ORGCTX_KILL\'); location.reload();')">
            <strong>2. Desactivar Kill Switch (si estaba activo):</strong><br>
            localStorage.removeItem('ORGCTX_KILL'); location.reload();
        </div>
        
        <div class="cmd" onclick="copyCmd(this, 'console.clear(); console.log(\'Watching for loops...\');')">
            <strong>3. Limpiar consola y observar:</strong><br>
            console.clear(); console.log('Watching for loops...');
        </div>
    </div>
    
    <div class="section">
        <h2>‚úÖ Resultado Esperado (UN SOLO CICLO)</h2>
        <div class="result success">
            <pre>
[OrgCtx] render #1, uid: xxx, pathname: /dashboard
[OrgCtx] load:start { uid: xxx, when: 1234567890 }
[OrgCtx] fetch:start { uid: xxx }
[OrgCtx] result { source: 'organization_members.user_id', count: 2, duration: 250ms }
[OrgCtx] load:done { status: 'success', count: 2 }
            </pre>
            <p>‚úÖ NO m√°s repeticiones de load:start</p>
            <p>‚úÖ NO m√°s "Loading memberships for user"</p>
            <p>‚úÖ Dashboard estable sin loops</p>
        </div>
    </div>
    
    <div class="section">
        <h2>üîç Verificaci√≥n Adicional</h2>
        <div class="cmd" onclick="copyCmd(this, 'Array.from(document.querySelectorAll(\'*\')).filter(el => el.__reactFiber$).map(el => el.__reactFiber$).filter(f => f.type?.name === \'OrgProvider\').length')">
            <strong>Verificar que solo hay UN OrgProvider:</strong><br>
            // Deber√≠a retornar: 1
        </div>
    </div>
    
    <div class="section">
        <h2>üìä M√©tricas del Fix</h2>
        <ul>
            <li>‚úÖ Module-scope loaders previenen re-fetches</li>
            <li>‚úÖ Router > OrgProvider orden correcto</li>
            <li>‚úÖ Dependencies m√≠nimas en useEffect</li>
            <li>‚úÖ Debug traces solo en DEV</li>
            <li>‚úÖ fetchUserMemberships con fallbacks</li>
        </ul>
    </div>
    
    <script>
        function copyCmd(el, cmd) {
            navigator.clipboard.writeText(cmd);
            el.style.background = '#0f0';
            el.style.color = '#000';
            setTimeout(() => {
                el.style.background = '#000';
                el.style.color = '#0f0';
            }, 200);
            console.log('Copied:', cmd);
        }
    </script>
</body>
</html>
